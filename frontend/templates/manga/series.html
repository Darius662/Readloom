{% extends 'base.html' %}

{% block title %}Readloom - {{ series.title }}{% endblock %}

{% block content %}
<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11" id="toast-container"></div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="series-header-title">Series Details</h5>
                <div class="d-flex gap-3">
                    <button class="btn btn-sm btn-outline-primary rounded-circle" id="edit-series-btn-header" title="Edit Series">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" id="move-series-btn-header" title="Move Series" data-bs-toggle="modal" data-bs-target="#moveSeriesModal">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger rounded-circle" id="delete-series-btn-header" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="series-details">
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4" id="ebook-management-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">E-book Management</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#ebookManagementCollapse" aria-expanded="false" aria-controls="ebookManagementCollapse">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    <div class="collapse" id="ebookManagementCollapse">
        <div class="card-body">
            <div class="mb-3">
                <strong>Folder Location</strong>
                <p class="mb-1">Place your e-book files in this folder: <code id="folder-path-info-management">Loading...</code></p>
            </div>
            <div class="mb-3">
                <strong>Supported file formats:</strong> PDF, EPUB, CBZ, CBR, MOBI, AZW
            </div>
            <div class="mb-3">
                <strong>Naming convention:</strong> "Volume 1.pdf", "Vol 2.epub", "v3.cbz"
            </div>
            <div class="mb-3">
                <strong>To set a custom path for this series, use the Edit Series button above.</strong>
            </div>
            <div class="mb-3">
                <strong>Scan your data directory for e-books and automatically add them to the database</strong>
                <div class="mt-2">
                    <button class="btn btn-primary" id="scan-for-ebooks">
                        <i class="fas fa-search me-1"></i> Scan for E-books
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Quick Actions Footer -->
    <div class="card-footer d-flex justify-content-between align-items-center">
        <span class="text-muted small">Quick Actions</span>
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#moveSeriesModal" title="Move Series">
                <i class="fas fa-arrows-alt"></i> Move
            </button>
            <button class="btn btn-primary" id="scan-for-ebooks-quick">
                <i class="fas fa-search me-1"></i> Scan for E-books
            </button>
        </div>
    </div>
</div>

<!-- Move Series Modal -->
<div class="modal fade" id="moveSeriesModal" tabindex="-1" aria-labelledby="moveSeriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveSeriesModalLabel">Move Series</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="move-series-form">
                    <div class="mb-3">
                        <label for="move-target-collection" class="form-label">Target Collection</label>
                        <select class="form-select" id="move-target-collection"></select>
                        <div class="form-text">Only collections in the same bucket as this series are listed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="move-target-root-folder" class="form-label">Target Root Folder (optional)</label>
                        <select class="form-select" id="move-target-root-folder">
                            <option value="">Auto-select first root folder</option>
                        </select>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="move-files-switch">
                        <label class="form-check-label" for="move-files-switch">Physically move files</label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="clear-custom-path-switch">
                        <label class="form-check-label" for="clear-custom-path-switch">Clear custom path after move</label>
                    </div>
                    <div class="border rounded p-2 bg-light">
                        <div class="small text-muted">Dry Run Preview</div>
                        <pre id="move-dryrun-output" class="mb-0" style="white-space: pre-wrap; max-height: 200px; overflow:auto;">No plan yet</pre>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="move-dryrun-btn">Preview (Dry Run)</button>
                <button type="button" class="btn btn-primary" id="move-execute-btn">Execute Move</button>
            </div>
        </div>
    </div>
 </div>

<div class="row mb-4" id="volumes-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Volumes</h5>
                <button class="btn btn-sm btn-primary" id="add-volume-btn">
                    <i class="fas fa-plus"></i> Add Volume
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="volumes-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Release Date</th>
                                <th>Format</th>
                                <th>Digital Format</th>
                                <th>File</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="volumes-list">
                            <tr>
                                <td colspan="7" class="text-center">No volumes found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="chapters-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Chapters</h5>
                <button class="btn btn-sm btn-primary" id="add-chapter-btn">
                    <i class="fas fa-plus"></i> Add Chapter
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="chapters-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Volume</th>
                                <th>Release Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chapters-list">
                            <tr>
                                <td colspan="6" class="text-center">No chapters found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="upcoming-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upcoming Releases</h5>
            </div>
            <div class="card-body">
                <div id="upcoming-events" class="list-group">
                    <div class="text-center py-3">No upcoming releases</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Volume Modal -->
<div class="modal fade" id="volumeModal" tabindex="-1" aria-labelledby="volumeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="volumeModalLabel">Add Volume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="volume-form">
                    <input type="hidden" id="volume-id">
                    <div class="mb-3">
                        <label for="volume-number" class="form-label">Volume Number *</label>
                        <input type="text" class="form-control" id="volume-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="volume-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="volume-title">
                    </div>
                    <div class="mb-3">
                        <label for="volume-description" class="form-label">Description</label>
                        <textarea class="form-control" id="volume-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="volume-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="volume-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="volume-cover-url" class="form-label">Cover URL</label>
                        <input type="url" class="form-control" id="volume-cover-url">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-volume-btn">Save Volume</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Chapter Modal -->
<div class="modal fade" id="chapterModal" tabindex="-1" aria-labelledby="chapterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chapterModalLabel">Add Chapter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="chapter-form">
                    <input type="hidden" id="chapter-id">
                    <div class="mb-3">
                        <label for="chapter-number" class="form-label">Chapter Number *</label>
                        <input type="text" class="form-control" id="chapter-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="chapter-title">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-volume" class="form-label">Volume</label>
                        <select class="form-select" id="chapter-volume">
                            <option value="">None</option>
                            <!-- Volumes will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-description" class="form-label">Description</label>
                        <textarea class="form-control" id="chapter-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="chapter-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-status" class="form-label">Status</label>
                        <select class="form-select" id="chapter-status">
                            <option value="ANNOUNCED">Announced</option>
                            <option value="RELEASED">Released</option>
                            <option value="DELAYED">Delayed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-read-status" class="form-label">Read Status</label>
                        <select class="form-select" id="chapter-read-status">
                            <option value="UNREAD">Unread</option>
                            <option value="READING">Reading</option>
                            <option value="READ">Read</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-chapter-btn">Save Chapter</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Series Modal -->
<div class="modal fade" id="seriesModal" tabindex="-1" aria-labelledby="seriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="seriesModalLabel">Edit Series</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="series-form">
                    <div class="mb-3">
                        <label for="series-title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="series-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="series-author" class="form-label">Author</label>
                        <input type="text" class="form-control" id="series-author">
                    </div>
                    <div class="mb-3">
                        <label for="series-publisher" class="form-label">Publisher</label>
                        <input type="text" class="form-control" id="series-publisher">
                    </div>
                    <div class="mb-3">
                        <label for="series-content-type" class="form-label">Content Type</label>
                        <select class="form-select" id="series-content-type">
                            <!-- Content types will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="series-status" class="form-label">Status</label>
                        <select class="form-select" id="series-status">
                            <option value="ONGOING">Ongoing</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="HIATUS">Hiatus</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="UNKNOWN">Unknown</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="series-description" class="form-label">Description</label>
                        <textarea class="form-control" id="series-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="series-cover-url" class="form-label">Cover URL</label>
                        <input type="url" class="form-control" id="series-cover-url">
                    </div>
                    <div class="mb-3">
                        <label for="series-custom-path" class="form-label">Custom Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="series-custom-path" placeholder="/path/to/manga/folder or C:\Path\to\manga\folder">
                            <button class="btn btn-outline-secondary" type="button" id="validate-series-custom-path-btn">Validate</button>
                        </div>
                        <div class="form-text">If your e-books are in a different location than the default, specify the full path here.</div>
                        <div id="series-custom-path-validation-status" class="mt-2"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="create-series-custom-path-btn" style="display: none;" disabled>
                                <i class="fas fa-folder-plus"></i> Create Folder
                            </button>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="import-from-custom-path">
                            <label class="form-check-label" for="import-from-custom-path">
                                Import files from custom folder
                            </label>
                            <div class="form-text">When saving, scan this folder for e-books and import them automatically.</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-series-btn">Save Series</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block styles %}
<style>
    /* E-book components styling */
    .ebook-file-container {
        width: 100%;
    }

    /* Move button styling to ensure visibility next to Edit */
    #move-series-btn {
        height: 38px;
        padding: 6px 10px;
        margin: 10px 0;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .ebook-file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px;
        border-radius: 4px;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .ebook-file-info {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 150px;
    }
    
    .digital-format-selector, .format-selector {
        min-width: 100px;
    }
    
    /* Edit button styling */
    #edit-series-btn {
        width: 38px;
        height: 38px;
        padding: 6px;
        margin: 10px;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    #edit-series-btn i {
        font-size: 16px;
    }
    
    /* Toast styling */
    .toast-container {
        z-index: 9999;
    }
    
    /* Modal styling fixes */
    .modal {
        overflow-y: auto !important;
        z-index: 1050 !important;
    }
    
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    .modal-dialog {
        margin: 1.75rem auto;
        max-width: 600px;
        width: auto;
        z-index: 1055 !important;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        background-color: var(--bs-modal-bg, #fff);
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    /* Ensure modal elements are clickable */
    .modal-header,
    .modal-body,
    .modal-footer,
    .modal-content button,
    .modal-content input,
    .modal-content .input-group {
        pointer-events: auto !important;
        position: relative;
        z-index: 1060 !important;
    }
</style>
{% endblock styles %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/folder-validation.js') }}"></script>
<script>
    $(document).ready(function() {
        const seriesId = "{{ series.id }}";
        let seriesData = null;
        let volumesData = [];
        let chaptersData = [];
        
        // Load series data
        function loadSeriesData() {
            $.ajax({
                url: `/api/series/${seriesId}`,
                method: 'GET',
                success: function(data) {
                    seriesData = data.series;
                    volumesData = data.volumes;
                    chaptersData = data.chapters;
                    // Expose globally for event handlers
                    try { window.currentSeries = seriesData; } catch (e) {}
                    
                    displaySeriesDetails();
                    displayVolumes();
                    displayChapters();
                    displayUpcomingEvents(data.upcoming_events);
                },
                error: function(error) {
                    console.error('Error loading series data:', error);
                    $('#series-details').html('<div class="col-12 text-center text-danger">Failed to load series data</div>');
                }
            });
        }
        
        // Process image URLs to handle proxy if needed
        function processImageUrl(url) {
            if (!url) return '';
            if (url.startsWith('http')) {
                return `/api/proxy/image?url=${encodeURIComponent(url)}`;
            }
            return url;
        }
        
        // Display series details
        function displaySeriesDetails() {
            const series = seriesData;
            
            const html = `
                <div class="row">
                        <div class="col-md-3">
                            <img src="${processImageUrl(series.cover_url)}" class="img-fluid rounded" alt="${series.title}">
                        </div>
                        <div class="col-md-9">
                            <h2>${series.title}</h2>
                            <p class="text-muted">${series.author ? `Author: ${series.author}` : ''} ${series.publisher ? `| Publisher: ${series.publisher}` : ''}</p>
                            <p>${series.description || 'No description available'}</p>
                            <div class="mb-3">
                                <span class="badge bg-secondary">${series.status || 'Unknown status'}</span>
                                <span class="badge bg-info">${series.content_type || 'MANGA'}</span>
                            </div>
                            <div class="mb-3">
                                <p class="mb-1">Place your e-book files in this folder: <code id="folder-path-info">Loading...</code></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#series-details').html(html);
            
            // Update header title
            $('#series-header-title').text(series.title);
            
            // Fetch folder path
            fetchSeriesFolderPath(series.id, series.title, series.content_type || 'MANGA');
            
            // Set up edit button
            $('#edit-series-btn-header').click(function() {
                // Load content types
                loadContentTypes().then(() => {
                    // Populate form with series data
                    $('#series-title').val(series.title);
                    $('#series-author').val(series.author || '');
                    $('#series-publisher').val(series.publisher || '');
                    $('#series-status').val(series.status || 'UNKNOWN');
                    $('#series-description').val(series.description || '');
                    $('#series-cover-url').val(series.cover_url || '');
                    $('#series-custom-path').val(series.custom_path || '');
                    
                    // Set content type if available, default to MANGA
                    const contentType = series.content_type || 'MANGA';
                    $('#series-content-type').val(contentType);
                    
                    // Show the modal
                    const seriesModal = new bootstrap.Modal(document.getElementById('seriesModal'));
                    seriesModal.show();
                });
            });
        }
        
        // Function to fetch series folder path
        function fetchSeriesFolderPath(seriesId, seriesTitle, contentType) {
            // Create a temporary object to create the path
            const data = {
                action: 'get_folder_path',
                series_id: seriesId,
                title: seriesTitle,
                content_type: contentType
            };
            
            fetch('/api/series/folder-path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching folder path:', data.error);
                    $('#folder-path-info').text('Error fetching path');
                    $('#folder-path-info-management').text('Error fetching path');
                } else {
                    const folderPath = data.folder_path;
                    $('#folder-path-info').text(folderPath);
                    $('#folder-path-info-management').text(folderPath);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#folder-path-info').text('Error fetching path');
                $('#folder-path-info-management').text('Error fetching path');
            });
        }
        
        // Function to load content types
        function loadContentTypes() {
            return fetch('/api/ebooks/content-types')
                .then(response => response.json())
                .then(data => {
                    const contentTypeSelect = $('#series-content-type');
                    contentTypeSelect.empty();
                    
                    // Add content type options
                    data.content_types.forEach(contentType => {
                        contentTypeSelect.append(`<option value="${contentType.id}">${contentType.name}</option>`);
                    });
                })
                .catch(error => {
                    console.error('Error loading content types:', error);
                });
        }
        
        // Display volumes
        function displayVolumes() {
            if (volumesData.length > 0) {
                let html = '';
                
                // Fetch collection items for this series
                fetch(`/api/collection?series_id=${seriesId}&item_type=VOLUME`)
                    .then(response => response.json())
                    .then(collectionData => {
                        const collectionItems = collectionData.items || [];
                        
                        // Fetch e-book files for this series
                        fetch(`/api/ebooks/series/${seriesId}`)
                            .then(response => response.json())
                            .then(ebookData => {
                                const ebookFiles = ebookData.files || [];
                                
                                volumesData.forEach(volume => {
                                    // Find collection item for this volume
                                    const collectionItem = collectionItems.find(item => item.volume_id === volume.id);
                                    
                                    // Find e-book file for this volume
                                    const ebookFile = ebookFiles.find(file => file.volume_id === volume.id);
                                    
                                    // Default values if no collection item exists
                                    let format = 'NONE';
                                    let digitalFormat = 'NONE';
                                    let hasFile = 0;
                                    
                                    if (collectionItem) {
                                        format = collectionItem.format || 'NONE';
                                        digitalFormat = collectionItem.digital_format || 'NONE';
                                        hasFile = collectionItem.has_file || 0;
                                    }
                                    
                                    // Auto-detect format and digital format from file if present
                                    if (ebookFile) {
                                        hasFile = 1;
                                        // If format is not set to DIGITAL or BOTH, set it to DIGITAL
                                        if (format !== 'DIGITAL' && format !== 'BOTH') {
                                            format = 'DIGITAL';
                                            // Auto-update the collection item
                                            updateVolumeFormat(volume.id, 'DIGITAL');
                                        }
                                        
                                        // Extract file extension to determine digital format
                                        const fileName = ebookFile.file_name;
                                        const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toUpperCase();
                                        
                                        // Map file extensions to digital formats
                                        const formatMap = {
                                            'PDF': 'PDF',
                                            'EPUB': 'EPUB',
                                            'CBZ': 'CBZ',
                                            'CBR': 'CBR',
                                            'MOBI': 'MOBI',
                                            'AZW': 'AZW',
                                            'AZW3': 'AZW'
                                        };
                                        
                                        const detectedFormat = formatMap[fileExtension];
                                        if (detectedFormat && digitalFormat !== detectedFormat) {
                                            digitalFormat = detectedFormat;
                                            // Auto-update the collection item
                                            updateVolumeDigitalFormat(volume.id, detectedFormat);
                                        }
                                    }
                                    
                                    // Format select options
                                    const formatOptions = [
                                        { value: 'PHYSICAL', label: 'Physical' },
                                        { value: 'DIGITAL', label: 'Digital' },
                                        { value: 'BOTH', label: 'Both' },
                                        { value: 'NONE', label: 'None' }
                                    ];
                                    
                                    let formatSelect = `<select class="form-select form-select-sm format-selector" data-volume-id="${volume.id}" data-series-id="${seriesId}">`;
                                    formatOptions.forEach(option => {
                                        formatSelect += `<option value="${option.value}"${format === option.value ? ' selected' : ''}>${option.label}</option>`;
                                    });
                                    formatSelect += '</select>';
                                    
                                    // Digital format select options
                                    const digitalFormatOptions = [
                                        { value: 'PDF', label: 'PDF' },
                                        { value: 'EPUB', label: 'EPUB' },
                                        { value: 'CBZ', label: 'CBZ' },
                                        { value: 'CBR', label: 'CBR' },
                                        { value: 'MOBI', label: 'MOBI' },
                                        { value: 'AZW', label: 'AZW' },
                                        { value: 'NONE', label: 'None' }
                                    ];
                                    
                                    let digitalFormatSelect = `<select class="form-select form-select-sm digital-format-selector" data-volume-id="${volume.id}" data-series-id="${seriesId}"${(format !== 'DIGITAL' && format !== 'BOTH') ? ' style="display:none;"' : ''}>`;
                                    digitalFormatOptions.forEach(option => {
                                        digitalFormatSelect += `<option value="${option.value}"${digitalFormat === option.value ? ' selected' : ''}>${option.label}</option>`;
                                    });
                                    digitalFormatSelect += '</select>';
                                    
                                    // File component
                                    let fileComponent = '-';
                                    if (ebookFile) {
                                        fileComponent = `
                                            <div class="d-flex align-items-center gap-2">
                                                <span>${ebookFile.file_name}</span>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="/api/ebooks/${ebookFile.id}" class="btn btn-outline-primary" target="_blank" title="Download">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                    <button class="btn btn-outline-danger delete-ebook-file" data-file-id="${ebookFile.id}" data-volume-id="${volume.id}" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    } else if (format === 'DIGITAL' || format === 'BOTH') {
                                        fileComponent = `<button class="btn btn-sm btn-outline-secondary ebook-upload-button" data-volume-id="${volume.id}" data-series-id="${seriesId}" title="Upload">
                                            <i class="fas fa-upload"></i>
                                        </button>`;
                                    }
                                    
                                    html += `
                                        <tr>
                                            <td>${volume.volume_number}</td>
                                            <td>${volume.title || '-'}</td>
                                            <td>${volume.release_date || '-'}</td>
                                            <td>${formatSelect}</td>
                                            <td>${digitalFormatSelect}</td>
                                            <td>${fileComponent}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary edit-volume" data-id="${volume.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger delete-volume" data-id="${volume.id}" data-number="${volume.volume_number}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                });
                                
                                $('#volumes-list').html(html);
                                $('#volumes-container').show();
                                
                                // Set up event handlers
                                setupVolumeEventHandlers();
                                
                                // Initialize format selectors
                                $('.format-selector').change(function() {
                                    const volumeId = $(this).data('volume-id');
                                    const format = $(this).val();
                                    
                                    if (format === 'DIGITAL' || format === 'BOTH') {
                                        $(`.digital-format-selector[data-volume-id="${volumeId}"]`).show();
                                        $(`.ebook-upload-button[data-volume-id="${volumeId}"]`).show();
                                    } else {
                                        $(`.digital-format-selector[data-volume-id="${volumeId}"]`).hide();
                                        $(`.ebook-upload-button[data-volume-id="${volumeId}"]`).hide();
                                    }
                                    
                                    // Save format to collection
                                    updateVolumeFormat(volumeId, format);
                                });
                                
                                // Initialize digital format selectors
                                $('.digital-format-selector').change(function() {
                                    const volumeId = $(this).data('volume-id');
                                    const digitalFormat = $(this).val();
                                    
                                    // Save digital format to collection
                                    updateVolumeDigitalFormat(volumeId, digitalFormat);
                                });
                                
                                // Initialize upload buttons
                                $('.ebook-upload-button').click(function() {
                                    const volumeId = $(this).data('volume-id');
                                    const seriesId = $(this).data('series-id');
                                    
                                    // Create file input
                                    const fileInput = $('<input type="file" accept=".pdf,.epub,.cbz,.cbr,.mobi,.azw,.azw3">');
                                    fileInput.change(function() {
                                        const file = this.files[0];
                                        if (file) {
                                            uploadEbookFile(seriesId, volumeId, file);
                                        }
                                    });
                                    fileInput.click();
                                });
                                
                                // Initialize delete ebook file buttons
                                $('.delete-ebook-file').click(function() {
                                    const fileId = $(this).data('file-id');
                                    const volumeId = $(this).data('volume-id');
                                    
                                    if (confirm('Are you sure you want to delete this ebook file?')) {
                                        deleteEbookFile(fileId, volumeId);
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching ebook files:', error);
                                $('#volumes-list').html('<tr><td colspan="7" class="text-center text-danger">Error loading volumes</td></tr>');
                            });
                    })
                    .catch(error => {
                        console.error('Error fetching collection items:', error);
                        $('#volumes-list').html('<tr><td colspan="7" class="text-center text-danger">Error loading volumes</td></tr>');
                    });
            } else {
                $('#volumes-list').html('<tr><td colspan="7" class="text-center">No volumes found</td></tr>');
                $('#volumes-container').show();
            }
        }
        
        // Display chapters
        function displayChapters() {
            $('#chapters-container').show();
            
            if (chaptersData && chaptersData.length > 0) {
                let chaptersHtml = '';
                
                chaptersData.forEach(chapter => {
                    const volumeNumber = chapter.volume_number || '-';
                    const status = chapter.read_status || 'UNREAD';
                    const statusClass = status === 'READ' ? 'bg-success' : (status === 'READING' ? 'bg-warning' : 'bg-secondary');
                    
                    chaptersHtml += `
                        <tr>
                            <td>${chapter.chapter_number}</td>
                            <td>${chapter.title || '-'}</td>
                            <td>${volumeNumber}</td>
                            <td>${chapter.release_date || '-'}</td>
                            <td><span class="badge ${statusClass}">${status}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-chapter" data-id="${chapter.id}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-chapter" data-id="${chapter.id}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                $('#chapters-list').html(chaptersHtml);
            } else {
                $('#chapters-list').html('<tr><td colspan="6" class="text-center">No chapters found</td></tr>');
            }
            
            // Set up event handlers for chapter actions
            setupChapterEventHandlers();
        }
        
        // Display upcoming events
        function displayUpcomingEvents(events) {
            if (events && events.length > 0) {
                $('#upcoming-container').show();
                
                let eventsHtml = '';
                events.forEach(event => {
                    const eventDate = new Date(event.event_date);
                    const formattedDate = eventDate.toLocaleDateString();
                    
                    eventsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${event.title}</h5>
                                <small>${formattedDate}</small>
                            </div>
                            <p class="mb-1">${event.description || ''}</p>
                        </div>
                    `;
                });
                
                $('#upcoming-events').html(eventsHtml);
            } else {
                $('#upcoming-events').html('<div class="text-center py-3">No upcoming releases</div>');
            }
        }
        
        // Setup volume event handlers
        function setupVolumeEventHandlers() {
            // Edit volume button
            $('.edit-volume').click(function() {
                const volumeId = $(this).data('id');
                const volume = volumesData.find(v => v.id == volumeId);
                
                if (volume) {
                    $('#volume-id').val(volume.id);
                    $('#volume-number').val(volume.volume_number);
                    $('#volume-title').val(volume.title || '');
                    $('#volume-release-date').val(volume.release_date || '');
                    $('#volume-description').val(volume.description || '');
                    $('#volume-cover-url').val(volume.cover_url || '');
                    
                    // Update modal title
                    $('#volumeModalLabel').text('Edit Volume');
                    
                    // Show the modal
                    const volumeModal = new bootstrap.Modal(document.getElementById('volumeModal'));
                    volumeModal.show();
                }
            });
            
            // Delete volume button
            $('.delete-volume').click(function() {
                const volumeId = $(this).data('id');
                if (confirm('Are you sure you want to delete this volume? This cannot be undone.')) {
                    deleteVolume(volumeId);
                }
            });
        }
        
        // Setup chapter event handlers
        function setupChapterEventHandlers() {
            // Edit chapter button
            $('.edit-chapter').click(function() {
                const chapterId = $(this).data('id');
                const chapter = chaptersData.find(c => c.id == chapterId);
                
                if (chapter) {
                    $('#chapter-id').val(chapter.id);
                    $('#chapter-number').val(chapter.chapter_number);
                    $('#chapter-title').val(chapter.title || '');
                    $('#chapter-volume').val(chapter.volume_id || '');
                    $('#chapter-release-date').val(chapter.release_date || '');
                    $('#chapter-status').val(chapter.read_status || 'UNREAD');
                    
                    // Update modal title
                    $('#chapterModalLabel').text('Edit Chapter');
                    
                    // Show the modal
                    const chapterModal = new bootstrap.Modal(document.getElementById('chapterModal'));
                    chapterModal.show();
                }
            });
            
            // Delete chapter button
            $('.delete-chapter').click(function() {
                const chapterId = $(this).data('id');
                if (confirm('Are you sure you want to delete this chapter? This cannot be undone.')) {
                    deleteChapter(chapterId);
                }
            });
        }
        
        // Update volume format
        function updateVolumeFormat(volumeId, format) {
            $.ajax({
                url: `/api/collection/volume/${volumeId}/format`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ format: format }),
                success: function(response) {
                    console.log('Volume format updated successfully');
                },
                error: function(xhr) {
                    console.error('Error updating volume format:', xhr.responseJSON?.error || 'Unknown error');
                }
            });
        }
        
        // Update volume digital format
        function updateVolumeDigitalFormat(volumeId, digitalFormat) {
            $.ajax({
                url: `/api/collection/volume/${volumeId}/digital-format`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ digital_format: digitalFormat }),
                success: function(response) {
                    console.log('Volume digital format updated successfully');
                },
                error: function(xhr) {
                    console.error('Error updating volume digital format:', xhr.responseJSON?.error || 'Unknown error');
                }
            });
        }
        
        // Upload ebook file
        function uploadEbookFile(seriesId, volumeId, file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('series_id', seriesId);
            formData.append('volume_id', volumeId);
            
            // Extract file extension to determine digital format
            const fileName = file.name;
            const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toUpperCase();
            
            // Map file extensions to digital formats
            const formatMap = {
                'PDF': 'PDF',
                'EPUB': 'EPUB',
                'CBZ': 'CBZ',
                'CBR': 'CBR',
                'MOBI': 'MOBI',
                'AZW': 'AZW',
                'AZW3': 'AZW'
            };
            
            const digitalFormat = formatMap[fileExtension] || 'NONE';
            
            $.ajax({
                url: '/api/ebooks/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    showToast('Success', 'Ebook file uploaded successfully', 'success');
                    
                    // Auto-set format to DIGITAL if not already set
                    updateVolumeFormat(volumeId, 'DIGITAL');
                    
                    // Auto-set digital format based on file extension
                    if (digitalFormat !== 'NONE') {
                        updateVolumeDigitalFormat(volumeId, digitalFormat);
                    }
                    
                    // Reload volumes to show the new file
                    setTimeout(() => loadSeriesData(), 500);
                },
                error: function(xhr) {
                    showToast('Error', xhr.responseJSON?.error || 'Failed to upload ebook file', 'danger');
                }
            });
        }
        
        // Delete ebook file
        function deleteEbookFile(fileId, volumeId) {
            $.ajax({
                url: `/api/ebooks/${fileId}`,
                method: 'DELETE',
                success: function(response) {
                    showToast('Success', 'Ebook file deleted successfully', 'success');
                    // Reload volumes to update the display
                    loadSeriesData();
                },
                error: function(xhr) {
                    showToast('Error', xhr.responseJSON?.error || 'Failed to delete ebook file', 'danger');
                }
            });
        }
        
        // Delete volume function
        function deleteVolume(volumeId) {
            $.ajax({
                url: `/api/volumes/${volumeId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showToast('Success', 'Volume deleted successfully', 'success');
                        // Remove from local data
                        volumesData = volumesData.filter(v => v.id != volumeId);
                        // Update display
                        displayVolumes();
                    } else {
                        showToast('Error', response.error || 'Failed to delete volume', 'danger');
                    }
                },
                error: function(xhr) {
                    showToast('Error', xhr.responseJSON?.error || 'Failed to delete volume', 'danger');
                }
            });
        }
        
        // Delete chapter function
        function deleteChapter(chapterId) {
            $.ajax({
                url: `/api/chapters/${chapterId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showToast('Success', 'Chapter deleted successfully', 'success');
                        // Remove from local data
                        chaptersData = chaptersData.filter(c => c.id != chapterId);
                        // Update display
                        displayChapters();
                    } else {
                        showToast('Error', response.error || 'Failed to delete chapter', 'danger');
                    }
                },
                error: function(xhr) {
                    showToast('Error', xhr.responseJSON?.error || 'Failed to delete chapter', 'danger');
                }
            });
        }
        
        // Call loadSeriesData on page load
        loadSeriesData();
        
        // Initialize tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();
        
        // Scan for e-books
        $('#scan-for-ebooks').click(function() {
            // Show loading indicator
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Scanning...');
            $btn.prop('disabled', true);
            
            console.log(`Scanning for e-books for series ${seriesId}`);
            
            // Call the API to scan for e-books
            try {
                console.log(`Making fetch request to /api/series/${seriesId}/scan`);
                
                fetch(`/api/series/${seriesId}/scan`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Received response:', response.status, response.statusText);
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.error || `HTTP error! Status: ${response.status}`);
                        }).catch(err => {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Scan response:', data);
                    if (data.success) {
                        showToast('Success', `Scan completed successfully. ${data.added || 0} files added, ${data.skipped || 0} skipped.`, 'success');
                        // Reload page to reflect changes
                        window.location.reload();
                    } else {
                        showToast('Error', data.error || 'Failed to scan for e-books', 'danger');
                        $btn.html(originalText);
                        $btn.prop('disabled', false);
                    }
                })
                .catch(error => {
                    console.error('Error scanning for e-books:', error);
                    showToast('Error', 'Failed to scan for e-books: ' + error.message, 'danger');
                    $btn.html(originalText);
                    $btn.prop('disabled', false);
                });
            } catch (error) {
                console.error('Exception in fetch operation:', error);
                showToast('Error', 'Exception in scan operation: ' + error.message, 'danger');
                $btn.html(originalText);
                $btn.prop('disabled', false);
            }
        });
        
        // Quick scan button handler (same as regular scan)
        $('#scan-for-ebooks-quick').click(function() {
            $('#scan-for-ebooks').click();
        });
        
        // Helper function to show toast notifications
        function showToast(title, message, type = 'info') {
            const toastHtml = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="toast-header bg-${type} text-white">
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            // Create toast container if it doesn't exist
            if ($('.toast-container').length === 0) {
                $('body').append('<div class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }
            
            // Add toast to container and show it
            const $toast = $(toastHtml);
            $('.toast-container').append($toast);
            const toast = new bootstrap.Toast($toast[0]);
            toast.show();
        }
    });
</script>
{% endblock scripts %}
