{% extends 'base.html' %}

{% block title %}Readloom - Homarr Integration{% endblock %}

{% block page_title %}Homarr Integration{% endblock %}

{% block styles %}
<style>
    .setup-step {
        margin-bottom: 30px;
    }
    
    .setup-step h4 {
        margin-bottom: 15px;
    }
    
    pre {
        background-color: #212529;
        color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
    
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    
    .note-list {
        background-color: rgba(13, 110, 253, 0.1);
        border-left: 4px solid #0d6efd;
        padding: 15px;
        border-radius: 5px;
    }
    
    .card-header-tabs {
        margin-right: -1rem;
        margin-bottom: -0.75rem;
        margin-left: -1rem;
    }
    
    .field-table {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .field-table th {
        background-color: rgba(0, 0, 0, 0.05);
        font-weight: 600;
    }
    
    .field-table th, .field-table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
    }
    
    .homarr-preview {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .homarr-preview-header {
        background-color: #212529;
        color: #fff;
        padding: 10px 15px;
        display: flex;
        align-items: center;
    }
    
    .homarr-preview-body {
        background-color: #f8f9fa;
        padding: 15px;
    }
    
    .homarr-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .homarr-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .homarr-card-icon {
        width: 40px;
        height: 40px;
        background-color: #0d6efd;
        color: #fff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    
    .homarr-card-title {
        font-weight: 600;
        margin: 0;
    }
    
    .homarr-card-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .homarr-card-stat {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="integration-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup" type="button" role="tab" aria-controls="setup" aria-selected="true">Setup Instructions</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="false">API Data</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">Preview</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="integration-tabs-content">
                    <!-- Setup Instructions Tab -->
                    <div class="tab-pane fade show active" id="setup" role="tabpanel" aria-labelledby="setup-tab">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i> Follow these steps to integrate Readloom with your Homarr dashboard.
                        </div>
                        
                        <div id="setup-instructions">
                            <div class="text-center py-5" id="loading-instructions">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading setup instructions...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Data Tab -->
                    <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i> This is the data that will be exposed to Homarr through the API.
                        </div>
                        
                        <div id="api-data">
                            <div class="text-center py-5" id="loading-data">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading API data...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Tab -->
                    <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i> This is a preview of how Readloom will appear in your Homarr dashboard.
                        </div>
                        
                        <div class="homarr-preview">
                            <div class="homarr-preview-header">
                                <i class="fas fa-th-large me-2"></i> Homarr Dashboard
                            </div>
                            <div class="homarr-preview-body">
                                <div class="homarr-card">
                                    <div class="homarr-card-header">
                                        <div class="homarr-card-icon">
                                            <i class="fas fa-book"></i>
                                        </div>
                                        <h5 class="homarr-card-title">Readloom</h5>
                                    </div>
                                    <div class="homarr-card-content">
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">Online</div>
                                        </div>
                                        <div class="homarr-card-stats">
                                            <span class="homarr-card-stat" id="preview-series-count">
                                                <i class="fas fa-book-open me-1"></i> <span>0</span> Series
                                            </span>
                                            <span class="homarr-card-stat" id="preview-releases-today">
                                                <i class="fas fa-calendar-day me-1"></i> <span>0</span> Releases Today
                                            </span>
                                            <span class="homarr-card-stat" id="preview-owned-volumes">
                                                <i class="fas fa-bookmark me-1"></i> <span>0</span> Owned Volumes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load setup instructions
        function loadSetupInstructions() {
            const instructionsContainer = document.getElementById('setup-instructions');
            const loadingInstructions = document.getElementById('loading-instructions');
            
            fetch('/api/integrations/homarr/setup')
                .then(response => response.json())
                .then(data => {
                    // Hide loading
                    loadingInstructions.classList.add('d-none');
                    
                    // Create setup instructions
                    const title = document.createElement('h3');
                    title.className = 'mb-4';
                    title.textContent = data.title || 'Readloom Homarr Integration';
                    
                    const description = document.createElement('p');
                    description.className = 'mb-4';
                    description.textContent = data.description || 'Follow these steps to integrate Readloom with your Homarr dashboard.';
                    
                    instructionsContainer.appendChild(title);
                    instructionsContainer.appendChild(description);
                    
                    // API endpoint info
                    const endpointCard = document.createElement('div');
                    endpointCard.className = 'card mb-4';
                    
                    const endpointCardHeader = document.createElement('div');
                    endpointCardHeader.className = 'card-header';
                    endpointCardHeader.textContent = 'API Endpoint';
                    
                    const endpointCardBody = document.createElement('div');
                    endpointCardBody.className = 'card-body';
                    
                    const endpointUrl = document.createElement('div');
                    endpointUrl.className = 'input-group mb-3';
                    
                    const endpointInput = document.createElement('input');
                    endpointInput.type = 'text';
                    endpointInput.className = 'form-control';
                    endpointInput.value = data.api_endpoint || window.location.origin + '/api/integrations/homarr';
                    endpointInput.readOnly = true;
                    
                    const endpointCopyBtn = document.createElement('button');
                    endpointCopyBtn.className = 'btn btn-outline-secondary';
                    endpointCopyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    endpointCopyBtn.onclick = () => copyToClipboard(endpointInput.value);
                    
                    endpointUrl.appendChild(endpointInput);
                    endpointUrl.appendChild(endpointCopyBtn);
                    endpointCardBody.appendChild(endpointUrl);
                    endpointCard.appendChild(endpointCardHeader);
                    endpointCard.appendChild(endpointCardBody);
                    
                    instructionsContainer.appendChild(endpointCard);
                    
                    // Setup steps
                    if (data.steps && data.steps.length > 0) {
                        data.steps.forEach((step, index) => {
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'setup-step';
                            
                            const stepTitle = document.createElement('h4');
                            stepTitle.innerHTML = `${index + 1}. ${step.title}`;
                            
                            const stepDescription = document.createElement('p');
                            stepDescription.textContent = step.description;
                            
                            stepDiv.appendChild(stepTitle);
                            stepDiv.appendChild(stepDescription);
                            
                            // Add fields table if available
                            if (step.fields && step.fields.length > 0) {
                                const table = document.createElement('table');
                                table.className = 'field-table';
                                
                                const thead = document.createElement('thead');
                                const headerRow = document.createElement('tr');
                                
                                const nameHeader = document.createElement('th');
                                nameHeader.textContent = 'Field';
                                headerRow.appendChild(nameHeader);
                                
                                const valueHeader = document.createElement('th');
                                valueHeader.textContent = 'Value';
                                headerRow.appendChild(valueHeader);
                                
                                thead.appendChild(headerRow);
                                table.appendChild(thead);
                                
                                const tbody = document.createElement('tbody');
                                
                                step.fields.forEach(field => {
                                    const row = document.createElement('tr');
                                    
                                    const nameCell = document.createElement('td');
                                    nameCell.textContent = field.name;
                                    row.appendChild(nameCell);
                                    
                                    const valueCell = document.createElement('td');
                                    const valueDiv = document.createElement('div');
                                    valueDiv.className = 'input-group';
                                    
                                    const valueInput = document.createElement('input');
                                    valueInput.type = 'text';
                                    valueInput.className = 'form-control';
                                    valueInput.value = field.value;
                                    valueInput.readOnly = true;
                                    
                                    const valueCopyBtn = document.createElement('button');
                                    valueCopyBtn.className = 'btn btn-outline-secondary';
                                    valueCopyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                                    valueCopyBtn.onclick = () => copyToClipboard(field.value);
                                    
                                    valueDiv.appendChild(valueInput);
                                    valueDiv.appendChild(valueCopyBtn);
                                    valueCell.appendChild(valueDiv);
                                    
                                    row.appendChild(valueCell);
                                    tbody.appendChild(row);
                                });
                                
                                table.appendChild(tbody);
                                stepDiv.appendChild(table);
                            }
                            
                            instructionsContainer.appendChild(stepDiv);
                        });
                    }
                    
                    // Notes
                    if (data.notes && data.notes.length > 0) {
                        const notesTitle = document.createElement('h4');
                        notesTitle.className = 'mb-3';
                        notesTitle.textContent = 'Important Notes';
                        
                        const notesList = document.createElement('ul');
                        notesList.className = 'note-list';
                        
                        data.notes.forEach(note => {
                            const noteItem = document.createElement('li');
                            noteItem.className = 'mb-2';
                            noteItem.textContent = note;
                            notesList.appendChild(noteItem);
                        });
                        
                        instructionsContainer.appendChild(notesTitle);
                        instructionsContainer.appendChild(notesList);
                    }
                })
                .catch(error => {
                    console.error('Error loading setup instructions:', error);
                    loadingInstructions.classList.add('d-none');
                    
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger';
                    errorMessage.textContent = 'Failed to load setup instructions. Please try again later.';
                    
                    instructionsContainer.appendChild(errorMessage);
                });
        }
        
        // Load API data
        function loadApiData() {
            const dataContainer = document.getElementById('api-data');
            const loadingData = document.getElementById('loading-data');
            
            fetch('/api/integrations/homarr')
                .then(response => response.json())
                .then(data => {
                    // Hide loading
                    loadingData.classList.add('d-none');
                    
                    // Create JSON viewer
                    const jsonViewer = document.createElement('div');
                    jsonViewer.className = 'position-relative';
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'btn btn-sm btn-outline-light copy-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.onclick = () => copyToClipboard(JSON.stringify(data, null, 2));
                    
                    const jsonBlock = document.createElement('pre');
                    jsonBlock.textContent = JSON.stringify(data, null, 2);
                    
                    jsonViewer.appendChild(copyBtn);
                    jsonViewer.appendChild(jsonBlock);
                    
                    dataContainer.appendChild(jsonViewer);
                    
                    // Update preview
                    updatePreview(data);
                })
                .catch(error => {
                    console.error('Error loading API data:', error);
                    loadingData.classList.add('d-none');
                    
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger';
                    errorMessage.textContent = 'Failed to load API data. Please try again later.';
                    
                    dataContainer.appendChild(errorMessage);
                });
        }
        
        // Update preview with data
        function updatePreview(data) {
            if (data && data.info) {
                document.querySelector('#preview-series-count span').textContent = data.info.series_count || 0;
                document.querySelector('#preview-releases-today span').textContent = data.info.releases_today || 0;
                document.querySelector('#preview-owned-volumes span').textContent = data.info.owned_volumes || 0;
            }
        }
        
        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    // Show toast or alert
                    alert('Copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                });
        }
        
        // Load data when tab is shown
        document.getElementById('setup-tab').addEventListener('shown.bs.tab', function() {
            if (document.getElementById('loading-instructions').classList.contains('d-none')) {
                return;
            }
            loadSetupInstructions();
        });
        
        document.getElementById('data-tab').addEventListener('shown.bs.tab', function() {
            if (document.getElementById('loading-data').classList.contains('d-none')) {
                return;
            }
            loadApiData();
        });
        
        document.getElementById('preview-tab').addEventListener('shown.bs.tab', function() {
            if (document.getElementById('loading-data').classList.contains('d-none')) {
                loadApiData();
            }
        });
        
        // Initial load
        loadSetupInstructions();
    });
</script>
{% endblock %}
