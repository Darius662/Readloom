{% extends 'base.html' %}

{% block title %}MangaArr - Series Detail{% endblock %}

{% block page_title %}Series Detail{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row" id="series-details">
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="volumes-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Volumes</h5>
                <button class="btn btn-sm btn-primary" id="add-volume-btn">
                    <i class="fas fa-plus"></i> Add Volume
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="volumes-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Release Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="volumes-list">
                            <tr>
                                <td colspan="4" class="text-center">No volumes found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="chapters-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Chapters</h5>
                <button class="btn btn-sm btn-primary" id="add-chapter-btn">
                    <i class="fas fa-plus"></i> Add Chapter
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="chapters-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Volume</th>
                                <th>Release Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chapters-list">
                            <tr>
                                <td colspan="6" class="text-center">No chapters found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="upcoming-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upcoming Releases</h5>
            </div>
            <div class="card-body">
                <div id="upcoming-events" class="list-group">
                    <div class="text-center py-3">No upcoming releases</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Volume Modal -->
<div class="modal fade" id="volumeModal" tabindex="-1" aria-labelledby="volumeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="volumeModalLabel">Add Volume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="volume-form">
                    <input type="hidden" id="volume-id">
                    <div class="mb-3">
                        <label for="volume-number" class="form-label">Volume Number *</label>
                        <input type="text" class="form-control" id="volume-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="volume-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="volume-title">
                    </div>
                    <div class="mb-3">
                        <label for="volume-description" class="form-label">Description</label>
                        <textarea class="form-control" id="volume-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="volume-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="volume-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="volume-cover-url" class="form-label">Cover URL</label>
                        <input type="url" class="form-control" id="volume-cover-url">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-volume-btn">Save Volume</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Chapter Modal -->
<div class="modal fade" id="chapterModal" tabindex="-1" aria-labelledby="chapterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chapterModalLabel">Add Chapter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="chapter-form">
                    <input type="hidden" id="chapter-id">
                    <div class="mb-3">
                        <label for="chapter-number" class="form-label">Chapter Number *</label>
                        <input type="text" class="form-control" id="chapter-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="chapter-title">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-volume" class="form-label">Volume</label>
                        <select class="form-select" id="chapter-volume">
                            <option value="">None</option>
                            <!-- Volumes will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-description" class="form-label">Description</label>
                        <textarea class="form-control" id="chapter-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="chapter-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-status" class="form-label">Status</label>
                        <select class="form-select" id="chapter-status">
                            <option value="ANNOUNCED">Announced</option>
                            <option value="RELEASED">Released</option>
                            <option value="DELAYED">Delayed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-read-status" class="form-label">Read Status</label>
                        <select class="form-select" id="chapter-read-status">
                            <option value="UNREAD">Unread</option>
                            <option value="READING">Reading</option>
                            <option value="READ">Read</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-chapter-btn">Save Chapter</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const seriesId = {{ series_id }};
        let seriesData = null;
        let volumesData = [];
        let chaptersData = [];
        
        // Load series data
        function loadSeriesData() {
            $.ajax({
                url: `/api/series/${seriesId}`,
                method: 'GET',
                success: function(data) {
                    seriesData = data.series;
                    volumesData = data.volumes;
                    chaptersData = data.chapters;
                    
                    displaySeriesDetails();
                    displayVolumes();
                    displayChapters();
                    displayUpcomingEvents(data.upcoming_events);
                },
                error: function(error) {
                    console.error('Error loading series data:', error);
                    $('#series-details').html('<div class="col-12 text-center text-danger">Failed to load series data</div>');
                }
            });
        }
        
        // Display series details
        function displaySeriesDetails() {
            const series = seriesData;
            
            const html = `
                <div class="col-md-3">
                    <img src="${series.cover_url || '/static/img/no-cover.png'}" class="img-fluid rounded" alt="${series.title}">
                </div>
                <div class="col-md-9">
                    <h2>${series.title}</h2>
                    <p class="text-muted">${series.author ? `Author: ${series.author}` : ''} ${series.publisher ? `| Publisher: ${series.publisher}` : ''}</p>
                    <p>${series.description || 'No description available'}</p>
                    <div class="mb-3">
                        <span class="badge bg-secondary">${series.status || 'Unknown status'}</span>
                    </div>
                    <button class="btn btn-primary" id="edit-series-btn">
                        <i class="fas fa-edit"></i> Edit Series
                    </button>
                </div>
            `;
            
            $('#series-details').html(html);
            
            // Set up edit button
            $('#edit-series-btn').click(function() {
                // Implement edit functionality
                alert('Edit series functionality will be implemented here');
            });
        }
        
        // Display volumes
        function displayVolumes() {
            if (volumesData.length > 0) {
                let html = '';
                
                volumesData.forEach(volume => {
                    html += `
                        <tr>
                            <td>${volume.volume_number}</td>
                            <td>${volume.title || '-'}</td>
                            <td>${volume.release_date || '-'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-volume" data-id="${volume.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-volume" data-id="${volume.id}" data-number="${volume.volume_number}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                $('#volumes-list').html(html);
                $('#volumes-container').show();
                
                // Set up edit buttons
                $('.edit-volume').click(function() {
                    const volumeId = $(this).data('id');
                    editVolume(volumeId);
                });
                
                // Set up delete buttons
                $('.delete-volume').click(function() {
                    const volumeId = $(this).data('id');
                    const volumeNumber = $(this).data('number');
                    
                    $('#delete-message').text(`Are you sure you want to delete Volume ${volumeNumber}?`);
                    $('#confirm-delete-btn').data('type', 'volume').data('id', volumeId);
                    
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();
                });
            } else {
                $('#volumes-list').html('<tr><td colspan="4" class="text-center">No volumes found</td></tr>');
                $('#volumes-container').show();
            }
        }
        
        // Display chapters
        function displayChapters() {
            if (chaptersData.length > 0) {
                let html = '';
                
                chaptersData.forEach(chapter => {
                    // Find volume if it exists
                    let volumeNumber = '-';
                    if (chapter.volume_id) {
                        const volume = volumesData.find(v => v.id === chapter.volume_id);
                        if (volume) {
                            volumeNumber = volume.volume_number;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${chapter.chapter_number}</td>
                            <td>${chapter.title || '-'}</td>
                            <td>${volumeNumber}</td>
                            <td>${chapter.release_date || '-'}</td>
                            <td><span class="badge bg-${getStatusBadgeClass(chapter.status)}">${chapter.status || 'Unknown'}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-chapter" data-id="${chapter.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-chapter" data-id="${chapter.id}" data-number="${chapter.chapter_number}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                $('#chapters-list').html(html);
                $('#chapters-container').show();
                
                // Set up edit buttons
                $('.edit-chapter').click(function() {
                    const chapterId = $(this).data('id');
                    editChapter(chapterId);
                });
                
                // Set up delete buttons
                $('.delete-chapter').click(function() {
                    const chapterId = $(this).data('id');
                    const chapterNumber = $(this).data('number');
                    
                    $('#delete-message').text(`Are you sure you want to delete Chapter ${chapterNumber}?`);
                    $('#confirm-delete-btn').data('type', 'chapter').data('id', chapterId);
                    
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();
                });
            } else {
                $('#chapters-list').html('<tr><td colspan="6" class="text-center">No chapters found</td></tr>');
                $('#chapters-container').show();
            }
        }
        
        // Display upcoming events
        function displayUpcomingEvents(events) {
            if (events && events.length > 0) {
                let html = '';
                
                events.forEach(event => {
                    const eventDate = new Date(event.date);
                    const formattedDate = eventDate.toLocaleDateString();
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${event.title}</h6>
                                <small>${formattedDate}</small>
                            </div>
                            <small>${event.description}</small>
                        </div>
                    `;
                });
                
                $('#upcoming-events').html(html);
                $('#upcoming-container').show();
            } else {
                $('#upcoming-events').html('<div class="text-center py-3">No upcoming releases</div>');
                $('#upcoming-container').show();
            }
        }
        
        // Get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'RELEASED':
                    return 'success';
                case 'ANNOUNCED':
                    return 'info';
                case 'DELAYED':
                    return 'warning';
                case 'CANCELLED':
                    return 'danger';
                default:
                    return 'secondary';
            }
        }
        
        // Add volume
        $('#add-volume-btn').click(function() {
            // Reset form
            $('#volume-form')[0].reset();
            $('#volume-id').val('');
            $('#volumeModalLabel').text('Add Volume');
            
            const modal = new bootstrap.Modal(document.getElementById('volumeModal'));
            modal.show();
        });
        
        // Edit volume
        function editVolume(volumeId) {
            const volume = volumesData.find(v => v.id === volumeId);
            
            if (volume) {
                $('#volume-id').val(volume.id);
                $('#volume-number').val(volume.volume_number);
                $('#volume-title').val(volume.title);
                $('#volume-description').val(volume.description);
                $('#volume-release-date').val(volume.release_date);
                $('#volume-cover-url').val(volume.cover_url);
                
                $('#volumeModalLabel').text('Edit Volume');
                
                const modal = new bootstrap.Modal(document.getElementById('volumeModal'));
                modal.show();
            }
        }
        
        // Save volume
        $('#save-volume-btn').click(function() {
            const volumeNumber = $('#volume-number').val();
            
            if (!volumeNumber) {
                alert('Volume number is required');
                return;
            }
            
            const volumeData = {
                volume_number: volumeNumber,
                title: $('#volume-title').val(),
                description: $('#volume-description').val(),
                release_date: $('#volume-release-date').val(),
                cover_url: $('#volume-cover-url').val()
            };
            
            const volumeId = $('#volume-id').val();
            let url = `/api/series/${seriesId}/volumes`;
            let method = 'POST';
            
            if (volumeId) {
                url = `/api/volumes/${volumeId}`;
                method = 'PUT';
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(volumeData),
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('volumeModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error saving volume:', error);
                    alert('Failed to save volume');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Add chapter
        $('#add-chapter-btn').click(function() {
            // Reset form
            $('#chapter-form')[0].reset();
            $('#chapter-id').val('');
            $('#chapterModalLabel').text('Add Chapter');
            
            // Populate volumes dropdown
            populateVolumesDropdown();
            
            const modal = new bootstrap.Modal(document.getElementById('chapterModal'));
            modal.show();
        });
        
        // Edit chapter
        function editChapter(chapterId) {
            const chapter = chaptersData.find(c => c.id === chapterId);
            
            if (chapter) {
                // Populate volumes dropdown
                populateVolumesDropdown();
                
                $('#chapter-id').val(chapter.id);
                $('#chapter-number').val(chapter.chapter_number);
                $('#chapter-title').val(chapter.title);
                $('#chapter-volume').val(chapter.volume_id || '');
                $('#chapter-description').val(chapter.description);
                $('#chapter-release-date').val(chapter.release_date);
                $('#chapter-status').val(chapter.status);
                $('#chapter-read-status').val(chapter.read_status);
                
                $('#chapterModalLabel').text('Edit Chapter');
                
                const modal = new bootstrap.Modal(document.getElementById('chapterModal'));
                modal.show();
            }
        }
        
        // Populate volumes dropdown
        function populateVolumesDropdown() {
            let options = '<option value="">None</option>';
            
            volumesData.forEach(volume => {
                options += `<option value="${volume.id}">Volume ${volume.volume_number}</option>`;
            });
            
            $('#chapter-volume').html(options);
        }
        
        // Save chapter
        $('#save-chapter-btn').click(function() {
            const chapterNumber = $('#chapter-number').val();
            
            if (!chapterNumber) {
                alert('Chapter number is required');
                return;
            }
            
            const chapterData = {
                chapter_number: chapterNumber,
                title: $('#chapter-title').val(),
                volume_id: $('#chapter-volume').val() || null,
                description: $('#chapter-description').val(),
                release_date: $('#chapter-release-date').val(),
                status: $('#chapter-status').val(),
                read_status: $('#chapter-read-status').val()
            };
            
            const chapterId = $('#chapter-id').val();
            let url = `/api/series/${seriesId}/chapters`;
            let method = 'POST';
            
            if (chapterId) {
                url = `/api/chapters/${chapterId}`;
                method = 'PUT';
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(chapterData),
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('chapterModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error saving chapter:', error);
                    alert('Failed to save chapter');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Delete confirmation
        $('#confirm-delete-btn').click(function() {
            const type = $(this).data('type');
            const id = $(this).data('id');
            
            let url;
            if (type === 'volume') {
                url = `/api/volumes/${id}`;
            } else if (type === 'chapter') {
                url = `/api/chapters/${id}`;
            } else {
                return;
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
            
            $.ajax({
                url: url,
                method: 'DELETE',
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error deleting item:', error);
                    alert('Failed to delete item');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Initial load
        loadSeriesData();
    });
</script>
{% endblock %}
