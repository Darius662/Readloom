name: Sync GitHub Issues with Jira

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created, edited, deleted]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific GitHub issue number to sync (leave empty for all)'
        required: false
        type: string

jobs:
  sync-to-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Sync to Jira using REST APIs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue } = context.payload;
            
            // Handle manual trigger
            if (context.eventName === 'workflow_dispatch') {
              const issueNumber = '${{ github.event.inputs.issue_number }}';
              
              if (issueNumber) {
                // Fetch the specific issue
                const { data: specificIssue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                await syncIssueToJira(specificIssue);
              } else {
                // Fetch all open issues and sync them
                const issues = await github.paginate(github.rest.issues.listForRepo, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'all'
                });
                
                for (const iss of issues) {
                  // Skip pull requests
                  if (!iss.pull_request) {
                    await syncIssueToJira(iss);
                  }
                }
              }
            } else {
              // Handle automatic trigger from issue events
              if (issue && !issue.pull_request) {
                await syncIssueToJira(issue);
              }
            }

            async function syncIssueToJira(issue) {
              console.log(`Syncing issue #${issue.number} to Jira: ${issue.title}`);
              
              // Jira API configuration
              const jiraConfig = {
                host: '${{ secrets.JIRA_HOST }}',
                email: '${{ secrets.JIRA_USER_EMAIL }}',
                apiToken: '${{ secrets.JIRA_API_TOKEN }}',
                projectKey: 'RLM'
              };

              try {
                // First, let's get available issue types for the project
                const issueTypesResponse = await fetch(`https://${jiraConfig.host}/rest/api/2/issue/createmeta?projectKeys=${jiraConfig.projectKey}&expand=projects.issuetypes`, {
                  method: 'GET',
                  headers: {
                    'Authorization': 'Basic ' + Buffer.from(jiraConfig.email + ':' + jiraConfig.apiToken).toString('base64'),
                    'Content-Type': 'application/json',
                  },
                });

                if (!issueTypesResponse.ok) {
                  const errorText = await issueTypesResponse.text();
                  console.error('‚ùå Failed to fetch Jira issue types:', errorText);
                  return;
                }

                const metaData = await issueTypesResponse.json();
                const project = metaData.projects[0];
                const issueTypes = project.issuetypes;
                
                // Use the first available issue type, or fall back to "Task"
                const defaultIssueType = issueTypes.find(it => it.name === 'Task') || 
                                       issueTypes.find(it => it.name === 'Story') || 
                                       issueTypes.find(it => it.name === 'Bug') || 
                                       issueTypes[0];

                console.log(`Using issue type: ${defaultIssueType.name}`);

                // Create Jira issue
                const jiraResponse = await fetch(`https://${jiraConfig.host}/rest/api/2/issue`, {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Basic ' + Buffer.from(jiraConfig.email + ':' + jiraConfig.apiToken).toString('base64'),
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    fields: {
                      project: {
                        key: jiraConfig.projectKey
                      },
                      summary: `[GitHub] ${issue.title}`,
                      description: `${issue.body || 'No description provided'}\n\n---\n**GitHub Issue:** ${issue.html_url}`,
                      issuetype: {
                        id: defaultIssueType.id,
                        name: defaultIssueType.name
                      }
                    }
                  })
                });

                if (jiraResponse.ok) {
                  const jiraIssue = await jiraResponse.json();
                  console.log(`‚úÖ Created Jira issue: ${jiraIssue.key}`);
                  console.log(`üîó Jira URL: https://${jiraConfig.host}/browse/${jiraIssue.key}`);
                  
                  // Try to add comment to GitHub issue (but don't fail if we can't)
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: `üîó Synced to Jira: https://${jiraConfig.host}/browse/${jiraIssue.key}`
                    });
                  } catch (commentError) {
                    console.log('‚ö†Ô∏è Could not add comment to GitHub issue (permissions issue), but Jira sync was successful');
                  }
                  
                  return jiraIssue;
                } else {
                  const errorText = await jiraResponse.text();
                  console.error('‚ùå Jira API error:', jiraResponse.status, errorText);
                  
                  // Try to add error comment (but don't fail if we can't)
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: `‚ùå Failed to sync to Jira: ${jiraResponse.status} - ${errorText}`
                    });
                  } catch (commentError) {
                    console.log('‚ö†Ô∏è Could not add error comment to GitHub issue');
                  }
                }
              } catch (error) {
                console.error('‚ùå Unexpected error:', error.message);
                
                // Try to add error comment (but don't fail if we can't)
                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `‚ùå Error syncing to Jira: ${error.message}`
                  });
                } catch (commentError) {
                  console.log('‚ö†Ô∏è Could not add error comment to GitHub issue');
                }
              }
            }
